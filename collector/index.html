<!doctype html>
<html>
  <head>
    <title>Dev Server</title>
    <style>

    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var count = 0;
      socket.emit('config', {control: true});

      function reset() {
        count = 0;
        updateState();
      }
      function save() {
        socket.emit('control', {act: 'save', type: getState()});
        count += 1;
        updateState();
      }
      function _evaluate() {
        socket.emit('control', {act: 'evaluate'});
      }
      
      function selectDevice() {
        socket.emit('control', {act: 'device', name: getSelectedDevice()});
      }

      function getSelectedDevice() {
        var e = document.getElementById("device");
        if (e.selectedIndex != -1) {
          return e.options[e.selectedIndex].value; 
        } else {
          return null;
        }
      }
      
      function getState() {
        var mod = count % 3;
        if (mod == 0) return 'tob';
        else if (mod == 1) return 'pae';
        else return document.querySelector('input[name=type]:checked').value;
      }
      
      function updateState() {
        document.getElementById('state').innerHTML = getState();
      }
      
      socket.on('status', function(msg) {
        var div = document.getElementById('messages');
        div.innerHTML = msg + "<br>" + div.innerHTML;
      });

      socket.on('evaluation', function(msg) {
        var div = document.getElementById('evaluation');
        div.innerHTML = msg;
      });

      socket.on('devices', function(devices) {
        var selected = getSelectedDevice();
        var html = devices.map(s => "<option" + (s == selected ? " selected" : "") + ">" + s + "</option>").join('');
        document.getElementById('device').innerHTML = html;
        selectDevice();
      });
    </script>
  </head>
  <body>
    <h1>TPC Data Capture</h1>
    <div>
      <label><input type="radio" name="type" value="charge"> Tob-Pae-Charge</label>
      <label><input type="radio" name="type" value="attack"> Tob-Pae-Attack</label>
      <label><input type="radio" name="type" value="shield"> Tob-Pae-Shield</label>
    </div>
    <div>
      <select id="device" onchange="selectDevice(); return false;">
      </select>
    </div>
    <div>
      <button onclick="reset(); return false;">Reset</button>
      <button onclick="save(); return false;">Save</button>
      <button onclick="_evaluate(); return false;">Evaluate</button>
    </div>
    <pre id="evaluation"></pre>
    <pre>State: <span id="state">tob</span></pre>
    <pre id="messages">Status: Ready</pre>
  </body>
</html>
